version: '3.4'

services:
  gateway:
    image: ${DOCKER_REGISTRY-}gateway
    build: 
     context: .
     dockerfile: Gateway/Dockerfile
    container_name: gateway
    ports:
      - '8080:80'
    depends_on:
      - service-advertisement
      - service-user
    # environment:
    #     service-advertisement: "http://service-advertisement"
    #     service-user: "http://service-user"
    networks:
      - lplace-network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: 'rabbitmq'
    ports:
        - 5672:5672
        - 15672:15672
    volumes:
        - ~/.docker-conf/rabbitmq/data/:/var/lib/rabbitmq/
        - ~/.docker-conf/rabbitmq/log/:/var/log/rabbitmq
    networks:
      - lplace-network

  db:
    image: "mcr.microsoft.com/mssql/server"
    container_name: db
    environment:
        SA_PASSWORD: "Your_password123"
        ACCEPT_EULA: "Y"
    networks:
      - lplace-network
    volumes:
      - database-data:/var/opt/mssql

  service-advertisement:
    image: ${DOCKER_REGISTRY-}serviceadvertisement
    container_name: service-advertisement
    build:
      context: .
      dockerfile: Service-Advertisement/Dockerfile
    environment:
      RABBITMQ_URI: "rabbitmq://rabbitmq:5672/"
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
    ports:
      - '8082:80'
    depends_on:
      - db
      - rabbitmq
    networks:
      - lplace-network

  service-user:
    image: ${DOCKER_REGISTRY-}serviceuser
    container_name: service-user
    build:
      context: .
      dockerfile: Service-User/Dockerfile
    environment:
        RABBITMQ_URI: "rabbitmq://rabbitmq:5672/"
        RABBITMQ_USERNAME: guest
        RABBITMQ_PASSWORD: guest
    ports:
      - '8084:80'
    depends_on:
      - db
      - rabbitmq
    networks:
      - lplace-network



volumes:
    database-data:

networks:
  lplace-network:
    driver: bridge